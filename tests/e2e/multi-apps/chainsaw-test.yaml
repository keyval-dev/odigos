apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: multi-apps
spec:
  description: This e2e test runs a multi-apps scenario
  skipDelete: true
  steps:
  - name: Prepare destination
    try:
    - apply:
        file: 00-install-collector.yaml
    - assert:
        file: 00-assert.yaml
  - name: Install Odigos
    try:
    - script:
        content: ../../../cli/odigos install --version e2e-test
        timeout: 60s
    - assert:
        file: 01-assert.yaml
  - name: Install Demo App
    try:
    - script:
        timeout: 100s
        content: |
          docker pull keyval/odigos-demo-inventory:v0.1
          docker pull keyval/odigos-demo-membership:v0.1
          docker pull keyval/odigos-demo-coupon:v0.1
          docker pull keyval/odigos-demo-inventory:v0.1
          docker pull keyval/odigos-demo-frontend:v0.2
          kind load docker-image keyval/odigos-demo-inventory:v0.1
          kind load docker-image keyval/odigos-demo-membership:v0.1
          kind load docker-image keyval/odigos-demo-coupon:v0.1
          kind load docker-image keyval/odigos-demo-inventory:v0.1
          kind load docker-image keyval/odigos-demo-frontend:v0.2
    - apply:
        file: 02-install-simple-demo.yaml
    - assert:
        file: 02-assert.yaml
  - name: Detect Languages
    try:
    - apply:
        file: 03-instrument-ns.yaml
    - assert:
        file: 03-assert.yaml
  - name: Add Destination
    try:
    - apply:
        file: 04-add-destination.yaml
    - assert:
        file: 04-assert.yaml
  - name: Validate Trace Data
    try:
      - create:
          file: 05-generate-traffic.yaml
      - assert:
          file: 05-assert.yaml
          timeout: 20s
      # We sleep to allow traces to be collected
      - sleep:
          duration: 10s
      - script:
          content: |
            kubectl cp -c filecp traces/test-opentelemetry-collector-0:tmp/trace.json ./bats/traces-orig.json
            bats ./bats/verify.bats
#      description: sample assert operation
#    - description: sample error operation
#      error:
#        file: error.yaml
#    - delete:
#        ref:
#          apiVersion: v1
#          kind: Pod
#          name: foo
#      description: sample delete operation
#    - description: sample script operation
#      script:
#        content: echo "test namespace = $NAMESPACE"
